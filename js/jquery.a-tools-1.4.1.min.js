/*! 
 * a-tools 1.4.1
 * 
 * Copyright (c) 2009 Andrey Kramarev(andrey.kramarev[at]ampparit.com), Ampparit Inc. (www.ampparit.com)
 * Licensed under the MIT license.
 * http://www.ampparit.com/projects/a-tools/license.txt
 *
 * Basic usage:
 
    <textarea></textarea>
    <input type="text" />

    // Get current selection
    var sel = $("textarea").getSelection()
    
    // Replace current selection
    $("input").replaceSelection("foo");

    // Count characters
    alert($("textarea").countCharacters());

    // Set max length without callback function
    $("textarea").setMaxLength(7);

    // Set max length with callback function which will be called when limit is exceeded
    $("textarea").setMaxLength(10, function() {
        alert("hello")
    });

    // Removing limit:
    $("textarea").setMaxLength(-1);
    
    // Insert text at current caret position
    $("#textarea").insertAtCaretPos("hello");
    
    // Set caret position (1 = beginning, -1 = end)
    $("#textArea").setCaretPos(10);
    
    // Set Selection (1 = beginning)
    $("#textArea").setSelection(10,15);

 */
var caretPositionAmp; jQuery.fn.extend({getSelection:function(){var b=this.jquery?this[0]:this,a,c,f,h=0;b.onmousedown=function(){document.selection&&typeof b.selectionStart!="number"?document.selection.empty():window.getSelection().removeAllRanges()};if(document.selection){var d=document.selection.createRange(),e=0,i=0,g=0;if(b.value.match(/\n/g)!=null)h=b.value.match(/\n/g).length;if(d.text){f=d.text;if(typeof b.selectionStart=="number"){a=b.selectionStart;c=b.selectionEnd;if(a==c)return{start:a,end:c,text:d.text,length:c- a}}else{var j;a=b.createTextRange();c=a.duplicate();f=a.text;a.moveToBookmark(d.getBookmark());j=a.text;c.setEndPoint("EndToStart",a);if(f==j&&f!=d.text)return this;a=c.text.length;c=c.text.length+d.text.length}if(h>0)for(f=0;f<=h;f++){j=b.value.indexOf("\n",i);if(j!=-1&&j<a){i=j+1;e++;g=e}else if(j!=-1&&j>=a&&j<=c)if(j==a+1){e--;g--;i=j+1}else{i=j+1;g++}else f=h}if(d.text.indexOf("\n",0)==1)g+=2;a-=e;c-=g;return{start:a,end:c,text:d.text,length:c-a}}b.focus();if(typeof b.selectionStart=="number")a= b.selectionStart;else{d=document.selection.createRange();a=b.createTextRange();c=a.duplicate();a.moveToBookmark(d.getBookmark());c.setEndPoint("EndToStart",a);a=c.text.length}if(h>0)for(f=0;f<=h;f++){j=b.value.indexOf("\n",i);if(j!=-1&&j<a){i=j+1;e++}else f=h}a-=e;return{start:a,end:a,text:d.text,length:0}}else if(typeof b.selectionStart=="number"){a=b.selectionStart;c=b.selectionEnd;f=b.value.substring(b.selectionStart,b.selectionEnd);return{start:a,end:c,text:f,length:c-a}}else return{start:undefined, end:undefined,text:undefined,length:undefined}},replaceSelection:function(b){var a=this.jquery?this[0]:this,c,f;f=0;var h,d,e=0,i=0,g=a.scrollTop==undefined?0:a.scrollTop;if(document.selection&&typeof a.selectionStart!="number"){g=document.selection.createRange();if(typeof a.selectionStart!="number"){var j;d=a.createTextRange();h=d.duplicate();c=d.text;d.moveToBookmark(g.getBookmark());j=d.text;h.setEndPoint("EndToStart",d);if(c==j&&c!=g.text)return this}if(g.text){part=g.text;if(a.value.match(/\n/g)!= null)e=a.value.match(/\n/g).length;c=h.text.length;if(e>0)for(j=0;j<=e;j++){var k=a.value.indexOf("\n",f);if(k!=-1&&k<c){f=k+1;i++}else j=e}g.text=b;caretPositionAmp=h.text.length+b.length;d.move("character",caretPositionAmp);document.selection.empty();a.blur()}return this}else if(typeof a.selectionStart=="number"&&a.selectionStart!=a.selectionEnd){c=a.selectionStart;f=a.selectionEnd;a.value=a.value.substr(0,c)+b+a.value.substr(f);f=c+b.length;a.setSelectionRange(f,f);a.scrollTop=g;return this}return this}, setSelection:function(b,a){b=parseInt(b);a=parseInt(a);var c=this.jquery?this[0]:this;c.focus();if(typeof c.selectionStart!="number"){re=c.createTextRange();if(re.text.length<a)a=re.text.length+1}if(a<b)return this;if(document.selection){var f=0,h=0,d=0,e=0;if(typeof c.selectionStart!="number"){re.collapse(true);re.moveEnd("character",a);re.moveStart("character",b);re.select()}else if(typeof c.selectionStart=="number"){if(c.value.match(/\n/g)!=null)f=c.value.match(/\n/g).length;if(f>0)for(var i=0;i<= f;i++){var g=c.value.indexOf("\n",d);if(g!=-1&&g<b){d=g+1;h++;e=h}else if(g!=-1&&g>=b&&g<=a)if(g==b+1){h--;e--;d=g+1}else{d=g+1;e++}else i=f}b+=h;a+=e;c.selectionStart=b;c.selectionEnd=a}return this}else if(c.selectionStart){c.focus();c.selectionStart=b;c.selectionEnd=a;return this}},insertAtCaretPos:function(b){var a=this.jquery?this[0]:this,c,f,h,d,e,i,g=f=0,j=a.scrollTop==undefined?0:a.scrollTop;a.focus();if(document.selection&&typeof a.selectionStart!="number"){if(a.value.match(/\n/g)!=null)g= a.value.match(/\n/g).length;c=parseInt(caretPositionAmp);if(g>0)for(var k=0;k<=g;k++){var l=a.value.indexOf("\n",h);if(l!=-1&&l<=c){h=l+1;c-=1;f++}}}caretPositionAmp=parseInt(caretPositionAmp);a.onmouseup=function(){if(document.selection&&typeof a.selectionStart!="number"){a.focus();d=document.selection.createRange();e=a.createTextRange();i=e.duplicate();e.moveToBookmark(d.getBookmark());i.setEndPoint("EndToStart",e);caretPositionAmp=i.text.length}};if(document.selection&&typeof a.selectionStart!= "number"){d=document.selection.createRange();if(d.text.length!=0)return this;e=a.createTextRange();textLength=e.text.length;i=e.duplicate();e.moveToBookmark(d.getBookmark());i.setEndPoint("EndToStart",e);c=i.text.length;if(caretPositionAmp>0&&c==0){f=caretPositionAmp-f;e.move("character",f);e.select();d=document.selection.createRange();caretPositionAmp+=b.length}else if(!(caretPositionAmp>=0)&&textLength==0){d=document.selection.createRange();caretPositionAmp=b.length+textLength}else if(!(caretPositionAmp>= 0)&&c==0){e.move("character",textLength);e.select();d=document.selection.createRange();caretPositionAmp=b.length+textLength}else if(!(caretPositionAmp>=0)&&c>0){e.move("character",0);document.selection.empty();e.select();d=document.selection.createRange();caretPositionAmp=c+b.length}else if(caretPositionAmp>=0&&caretPositionAmp==textLength){if(textLength!=0){e.move("character",textLength);e.select()}else e.move("character",0);d=document.selection.createRange();caretPositionAmp=b.length+textLength}else{if(caretPositionAmp>= 0&&c!=0&&caretPositionAmp>=c){f=caretPositionAmp-c;e.move("character",f)}else caretPositionAmp>=0&&c!=0&&caretPositionAmp<c&&e.move("character",0);document.selection.empty();e.select();d=document.selection.createRange();caretPositionAmp+=b.length}d.text=b;a.focus();return this}else if(typeof a.selectionStart=="number"&&a.selectionStart==a.selectionEnd){h=a.selectionStart+b.length;c=a.selectionStart;f=a.selectionEnd;a.value=a.value.substr(0,c)+b+a.value.substr(f);a.setSelectionRange(h,h);a.scrollTop= j;return this}return this},setCaretPos:function(b){var a=this.jquery?this[0]:this,c,f=0,h=0,d;a.focus();if(parseInt(b)==0)return this;if(parseInt(b)>0){b=parseInt(b)-1;if(document.selection&&typeof a.selectionStart=="number"&&a.selectionStart==a.selectionEnd){if(a.value.match(/\n/g)!=null)f=a.value.match(/\n/g).length;if(f>0)for(var e=0;e<=f;e++){d=a.value.indexOf("\n",c);if(d!=-1&&d<=b){c=d+1;b=parseInt(b)+1}}}}else if(parseInt(b)<0){b=parseInt(b)+1;if(document.selection&&typeof a.selectionStart!= "number"){b=a.value.length+parseInt(b);if(a.value.match(/\n/g)!=null)f=a.value.match(/\n/g).length;if(f>0){for(e=0;e<=f;e++){d=a.value.indexOf("\n",c);if(d!=-1&&d<=b){c=d+1;b=parseInt(b)-1;h+=1}}b=b+h-f}}else if(document.selection&&typeof a.selectionStart=="number"){b=a.value.length+parseInt(b);if(a.value.match(/\n/g)!=null)f=a.value.match(/\n/g).length;if(f>0){b=parseInt(b)-f;for(e=0;e<=f;e++){d=a.value.indexOf("\n",c);if(d!=-1&&d<=b){c=d+1;b=parseInt(b)+1;h+=1}}}}else b=a.value.length+parseInt(b)}else return this; if(document.selection&&typeof a.selectionStart!="number"){c=document.selection.createRange();if(c.text!=0)return this;a=a.createTextRange();a.collapse(true);a.moveEnd("character",b);a.moveStart("character",b);a.select();caretPositionAmp=b;return this}else if(typeof a.selectionStart=="number"&&a.selectionStart==a.selectionEnd){a.setSelectionRange(b,b);return this}return this},countCharacters:function(){var b=this.jquery?this[0]:this;if(b.value.match(/\r/g)!=null)return b.value.length-b.value.match(/\r/g).length; return b.value.length},setMaxLength:function(b,a){this.each(function(){var c=this.jquery?this[0]:this,f=c.type,h,d;if(parseInt(b)<0)b=1E8;if(f=="text")c.maxLength=b;if(f=="textarea"||f=="text"){c.onkeypress=function(e){var i=c.value.match(/\r/g);d=b;if(i!=null)d=parseInt(d)+i.length;e=e||event;i=e.keyCode;h=document.selection?document.selection.createRange().text.length>0:c.selectionStart!=c.selectionEnd;if(c.value.length>=d&&(i>47||i==32||i==0||i==13)&&!e.ctrlKey&&!e.altKey&&!h){c.value=c.value.substring(0, d);typeof a=="function"&&a();return false}};c.onkeyup=function(){var e=c.value.match(/\r/g),i=0,g=0;d=b;if(e!=null){for(var j=0;j<=e.length;j++)if(c.value.indexOf("\n",g)<=parseInt(b)){i++;g=c.value.indexOf("\n",g)+1}d=parseInt(b)+i}if(c.value.length>d){c.value=c.value.substring(0,d);typeof a=="function"&&a();return this}}}else return this});return this}});